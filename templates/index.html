<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ Paratranz ë²ˆì—­ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 20px;
        }
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 15px;
                border-radius: 12px;
            }
            
            .header h1 {
                font-size: 1.5em !important;
            }
            
            .button-wrapper {
                min-width: 80px !important;
            }
            
            .button-wrapper kbd {
                font-size: 0.7em !important;
                padding: 1px 4px !important;
            }
            
            button {
                padding: 10px 12px !important;
                font-size: 0.85em !important;
            }
            
            .original-text, .translation-option {
                font-size: 0.9em;
                padding: 10px;
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            background: #f0f0f0;
            border-radius: 8px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box .label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-box .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }
        
        .original-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
        }
        
        .context-text {
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #856404;
            margin-bottom: 15px;
        }
        
        .translation-option {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .translation-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .translation-option.selected {
            border-color: #667eea;
            background: #e8f0ff;
        }
        
        .translation-option .number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.9em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 120px;
        }
        
        .button-wrapper kbd {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        button {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #e68900;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }
        
        .edit-area {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 10px;
        }
        
        .edit-area:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }
        
        .file-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-item:hover {
            background: #e8f0ff;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 1em;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.error {
            background: #f44336;
        }
        
        .toast.warning {
            background: #ff9800;
        }
        
        .toast.info {
            background: #2196f3;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .spinner {
            border: 4px solid #f0f0f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
            margin-bottom: 15px;
        }
        
        #loadingText {
            font-size: 1em;
            font-weight: bold;
            color: #333;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸŒ Paratranz ë²ˆì—­ê¸°</h1>
            <p>Gemini API ê¸°ë°˜ ê²Œì„ ë²ˆì—­ ë„êµ¬</p>
        </div>
        
        
        <!-- ì§„í–‰ë¥  -->
        <div id="progressSection" class="hidden">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
            </div>
        </div>
        
        <!-- í†µê³„ -->
        <div id="statsSection" class="stats hidden">
            <div class="stat-box">
                <div class="label">ğŸ“Š ì§„í–‰</div>
                <div class="value" id="statProgress">0/0</div>
            </div>
            <div class="stat-box">
                <div class="label">âœ… ì™„ë£Œ</div>
                <div class="value" id="statTranslated">0</div>
            </div>
        </div>
        
        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <div id="startSection">
            <!-- API í‚¤ ì„¤ì • -->
            <div id="apiKeySection" class="section">
                <div class="section-title">ğŸ”‘ API í‚¤ ì„¤ì •</div>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                    ì²˜ìŒ í•œ ë²ˆë§Œ ì…ë ¥í•˜ë©´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤.
                </p>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Paratranz API í‚¤:
                    </label>
                    <input type="password" id="paratranzApiKey" class="edit-area" 
                           style="min-height: auto; height: 40px;" 
                           placeholder="ì—¬ê¸°ì— Paratranz API í‚¤ ì…ë ¥">
                    <small style="color: #666;">
                        <a href="https://paratranz.cn/users/my" target="_blank">ì—¬ê¸°ì„œ ë°œê¸‰</a>
                    </small>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Gemini API í‚¤:
                    </label>
                    <input type="password" id="geminiApiKey" class="edit-area" 
                           style="min-height: auto; height: 40px;" 
                           placeholder="ì—¬ê¸°ì— Gemini API í‚¤ ì…ë ¥">
                    <small style="color: #666;">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank">ì—¬ê¸°ì„œ ë°œê¸‰</a>
                    </small>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Gemini ëª¨ë¸:
                    </label>
                    <select id="geminiModel" class="edit-area" style="min-height: auto; height: 50px; cursor: pointer; padding: 10px; font-size: 0.95em;">
                        <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite (1500/day, ë¹ ë¦„, ì €ë¹„ìš©)</option>
                        <option value="gemini-2.5-flash">gemini-2.5-flash (1500/day, ë¹ ë¦„, í’ˆì§ˆ ì¤‘ê°„)</option>
                        <option value="gemini-2.5-pro">gemini-2.5-pro (50/day, ëŠë¦¼, ìµœê³  í’ˆì§ˆ)</option>
                    </select>
                    <small style="color: #666;">
                        ëª¨ë¸ë³„ ì¼ì¼ í•œë„ì™€ í’ˆì§ˆì´ ë‹¤ë¦…ë‹ˆë‹¤
                    </small>
                </div>
                <button class="btn-success" onclick="saveApiKeys()">ğŸ’¾ ì €ì¥í•˜ê³  ì‹œì‘</button>
            </div>
            
            <!-- íŒŒì¼ ì„ íƒ (API í‚¤ ì…ë ¥ í›„ í‘œì‹œ) -->
            <div id="fileSection" class="section hidden">
                <div class="section-title">ğŸ“ íŒŒì¼ ì„ íƒ</div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="loadFiles()">íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button class="btn-secondary" onclick="showApiKeySection()">ğŸ”‘ API í‚¤ ë³€ê²½</button>
                </div>
            </div>
        </div>
        
        <div id="translationSection" class="hidden">
            <!-- ì›ë¬¸ -->
            <div class="section">
                <div class="section-title">ğŸ“ ì›ë¬¸</div>
                <div id="originalText" class="original-text"></div>
                <div id="contextText" class="context-text hidden"></div>
            </div>
            
            <!-- ë²ˆì—­ -->
            <div class="section">
                <div class="section-title">ğŸ¤– AI ë²ˆì—­ (2ê°€ì§€)</div>
                <div id="translation1" class="translation-option" onclick="selectTranslation(1)">
                    <span class="number">1</span>
                    <span class="text"></span>
                </div>
                <div id="translation2" class="translation-option" onclick="selectTranslation(2)">
                    <span class="number">2</span>
                    <span class="text"></span>
                </div>
            </div>
            
            <!-- í¸ì§‘ ì˜ì—­ (ìˆ¨ê¹€) -->
            <div id="editSection" class="section hidden">
                <div class="section-title">âœï¸ ë²ˆì—­ í¸ì§‘</div>
                <textarea id="editArea" class="edit-area" placeholder="ë²ˆì—­ì„ ìˆ˜ì •í•˜ì„¸ìš”..."></textarea>
            </div>
            
            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div id="actionButtons" class="button-group">
                <div class="button-wrapper">
                    <kbd>1</kbd>
                    <button class="btn-primary" onclick="selectAction(1)">ğŸ“ ì²« ë²ˆì§¸</button>
                </div>
                <div class="button-wrapper">
                    <kbd>2</kbd>
                    <button class="btn-primary" onclick="selectAction(2)">ğŸ“ ë‘ ë²ˆì§¸</button>
                </div>
                <div class="button-wrapper">
                    <kbd>3</kbd>
                    <button class="btn-secondary" onclick="selectAction(3)">ğŸ“š ìš©ì–´ì§‘</button>
                </div>
                <div class="button-wrapper">
                    <kbd>4</kbd>
                    <button class="btn-secondary" onclick="selectAction(4)">â­ï¸ ê±´ë„ˆë›°ê¸°</button>
                </div>
            </div>
            
            <!-- ì €ì¥ ë²„íŠ¼ (ìˆ¨ê¹€) -->
            <div id="saveButtons" class="button-group hidden">
                <div class="button-wrapper">
                    <kbd>1</kbd>
                    <button class="btn-success" onclick="saveAction(1)">ğŸ’¾ ì €ì¥</button>
                </div>
                <div class="button-wrapper">
                    <kbd>2</kbd>
                    <button class="btn-warning" onclick="saveAction(2)">ğŸ“ ê²€í† </button>
                </div>
                <div id="editButtonWrapper" class="button-wrapper">
                    <kbd>3</kbd>
                    <button class="btn-warning" onclick="saveAction(3)">âœï¸ í¸ì§‘</button>
                </div>
                <div id="cancelButtonWrapper" class="button-wrapper">
                    <kbd id="cancelKbd">4</kbd>
                    <button class="btn-secondary" onclick="saveAction(4)">âŒ ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
        
        <!-- ë¡œë”© -->
        <div id="loadingSection" class="loading hidden">
            <div class="spinner"></div>
            <div id="loadingText">ì²˜ë¦¬ ì¤‘...</div>
        </div>
        
    </div>
    
    <!-- íŒŒì¼ ì„ íƒ ëª¨ë‹¬ -->
    <div id="fileModal" class="modal">
        <div class="modal-content">
            <div class="section-title">ğŸ“ íŒŒì¼ ì„ íƒ</div>
            <select id="fileSelect" size="10" style="height: 300px;"></select>
            <div style="margin-top: 15px;">
                <div class="section-title">ğŸ“Š ë²ˆì—­ ë‹¨ê³„ ì„ íƒ</div>
                <select id="stageSelect">
                    <option value="0">ë¯¸ë²ˆì—­</option>
                    <option value="1">ë²ˆì—­ë¨</option>
                    <option value="5">ê²€í† ë¨</option>
                </select>
            </div>
            <div class="button-group" style="margin-top: 15px;">
                <button class="btn-primary" onclick="startTranslation()">ì‹œì‘</button>
                <button class="btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
    
    <!-- ìš©ì–´ì§‘ ëª¨ë‹¬ -->
    <div id="glossaryModal" class="modal">
        <div class="modal-content">
            <div class="section-title">ğŸ“š ìš©ì–´ì§‘ ê´€ë¦¬</div>
            <div id="glossaryList" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;"></div>
            <div class="button-group">
                <button class="btn-primary" onclick="addGlossaryTerm()">ì¶”ê°€</button>
                <button class="btn-secondary" onclick="closeGlossaryModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        let selectedTranslation = null;
        let currentData = null;
        let selectedFileId = null;
        let selectedStage = null;
        let userApiKeys = {
            paratranz: '',
            gemini: '',
            model: 'gemini-2.5-flash-lite'
        };
        let sessionId = null;  // ğŸ”’ ì„¸ì…˜ ID (ì ê¸ˆìš©)
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ API í‚¤ í™•ì¸ + ì„¸ì…˜ ID ìƒì„±
        window.addEventListener('DOMContentLoaded', async () => {
            // ğŸ”’ ì„¸ì…˜ ID ìƒì„±
            try {
                const response = await fetch('/api/session');
                const data = await response.json();
                sessionId = data.session_id;
                console.log('ğŸ”’ ì„¸ì…˜ ID:', sessionId.substring(0, 8) + '...');
            } catch (e) {
                console.error('ì„¸ì…˜ ID ìƒì„± ì‹¤íŒ¨:', e);
                sessionId = 'fallback-' + Date.now();
            }
            
            loadSavedApiKeys();
        });
        
        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 3ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // ì €ì¥ëœ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadSavedApiKeys() {
            const paratranzKey = localStorage.getItem('paratranz_api_key');
            const geminiKey = localStorage.getItem('gemini_api_key');
            const geminiModel = localStorage.getItem('gemini_model') || 'gemini-2.5-flash-lite';
            
            if (paratranzKey && geminiKey) {
                userApiKeys.paratranz = paratranzKey;
                userApiKeys.gemini = geminiKey;
                userApiKeys.model = geminiModel;
                
                // API í‚¤ê°€ ìˆìœ¼ë©´ íŒŒì¼ ì„ íƒ í™”ë©´ìœ¼ë¡œ
                document.getElementById('apiKeySection').classList.add('hidden');
                document.getElementById('fileSection').classList.remove('hidden');
            } else {
                // API í‚¤ê°€ ì—†ìœ¼ë©´ ì…ë ¥ í™”ë©´ í‘œì‹œ
                document.getElementById('apiKeySection').classList.remove('hidden');
                document.getElementById('fileSection').classList.add('hidden');
            }
        }
        
        // API í—¤ë” ìƒì„± (ëª¨ë“  API í˜¸ì¶œì— ì‚¬ìš©)
        function getApiHeaders(additionalHeaders = {}) {
            return {
                'X-Paratranz-Key': userApiKeys.paratranz,
                'X-Gemini-Key': userApiKeys.gemini,
                'X-Gemini-Model': userApiKeys.model,
                'X-Session-ID': sessionId,  // ğŸ”’ ì ê¸ˆìš© ì„¸ì…˜ ID
                ...additionalHeaders
            };
        }
        
        // API í‚¤ ì €ì¥
        function saveApiKeys() {
            const paratranzKey = document.getElementById('paratranzApiKey').value.trim();
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            const geminiModel = document.getElementById('geminiModel').value;
            
            if (!paratranzKey || !geminiKey) {
                showToast('ëª¨ë“  API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
                return;
            }
            
            // localStorageì— ì €ì¥
            localStorage.setItem('paratranz_api_key', paratranzKey);
            localStorage.setItem('gemini_api_key', geminiKey);
            localStorage.setItem('gemini_model', geminiModel);
            
            userApiKeys.paratranz = paratranzKey;
            userApiKeys.gemini = geminiKey;
            userApiKeys.model = geminiModel;
            
            // íŒŒì¼ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì „í™˜
            document.getElementById('apiKeySection').classList.add('hidden');
            document.getElementById('fileSection').classList.remove('hidden');
            
            showToast('âœ… API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
        
        // API í‚¤ ì„¤ì • í™”ë©´ ë‹¤ì‹œ ë³´ê¸°
        function showApiKeySection() {
            document.getElementById('fileSection').classList.add('hidden');
            document.getElementById('apiKeySection').classList.remove('hidden');
            
            // í˜„ì¬ ì €ì¥ëœ í‚¤ í‘œì‹œ
            const paratranzKey = localStorage.getItem('paratranz_api_key');
            const geminiKey = localStorage.getItem('gemini_api_key');
            const geminiModel = localStorage.getItem('gemini_model') || 'gemini-2.5-flash-lite';
            
            if (paratranzKey) {
                document.getElementById('paratranzApiKey').value = paratranzKey;
            }
            if (geminiKey) {
                document.getElementById('geminiApiKey').value = geminiKey;
            }
            document.getElementById('geminiModel').value = geminiModel;
        }
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        document.addEventListener('keydown', (e) => {
            // ì…ë ¥ ì¤‘ì´ë©´ ë¬´ì‹œ
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            
            const key = e.key;
            
            // ë²ˆì—­ í™”ë©´
            if (!document.getElementById('translationSection').classList.contains('hidden')) {
                // ì €ì¥ ë²„íŠ¼ì´ ë³´ì´ë©´
                if (!document.getElementById('saveButtons').classList.contains('hidden')) {
                    // í¸ì§‘ ëª¨ë“œì¸ì§€ í™•ì¸
                    const isEditMode = !document.getElementById('editSection').classList.contains('hidden');
                    
                    if (isEditMode) {
                        // í¸ì§‘ ëª¨ë“œ: 1(ì €ì¥), 2(ê²€í† ), 3(ì·¨ì†Œ)
                        if (key === '1') saveAction(1);
                        else if (key === '2') saveAction(2);
                        else if (key === '3') saveAction(4); // 3ë²ˆ í‚¤ = ì·¨ì†Œ
                    } else {
                        // ì¼ë°˜ ëª¨ë“œ: 1(ì €ì¥), 2(ê²€í† ), 3(í¸ì§‘), 4(ì·¨ì†Œ)
                        if (key >= '1' && key <= '4') {
                            saveAction(parseInt(key));
                        }
                    }
                }
                // ì•¡ì…˜ ë²„íŠ¼ì´ ë³´ì´ë©´
                else if (!document.getElementById('actionButtons').classList.contains('hidden')) {
                    if (key >= '1' && key <= '4') {
                        selectAction(parseInt(key));
                    }
                }
            }
        });
        
        // íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadFiles() {
            showLoading('íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                const response = await fetch('/api/files', {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                hideLoading();
                
                if (data.success) {
                    const select = document.getElementById('fileSelect');
                    select.innerHTML = '';
                    
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.id;
                        option.textContent = `${file.name} (${file.translated}/${file.total})`;
                        select.appendChild(option);
                    });
                    
                    document.getElementById('fileModal').classList.add('show');
                } else {
                    alert('íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ë²ˆì—­ ì‹œì‘
        async function startTranslation() {
            const select = document.getElementById('fileSelect');
            const stageSelect = document.getElementById('stageSelect');
            
            if (!select.value) {
                alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”');
                return;
            }
            
            selectedFileId = parseInt(select.value);
            selectedStage = parseInt(stageSelect.value);
            
            closeModal();
            showLoading('ë²ˆì—­ ì¤€ë¹„ ì¤‘...');
            
            try {
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: getApiHeaders({'Content-Type': 'application/json'}),
                    body: JSON.stringify({
                        file_id: selectedFileId,
                        stage: selectedStage
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    if (data.completed) {
                        alert('ğŸ‰ ëª¨ë“  ë²ˆì—­ ì™„ë£Œ!\n\në‹¤ë¥¸ íŒŒì¼ì„ ì„ íƒí•˜ë ¤ë©´ ìƒˆë¡œê³ ì¹¨(F5)í•˜ì„¸ìš”.');
                    } else {
                        loadCurrentItem();
                    }
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // í˜„ì¬ í•­ëª© ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadCurrentItem() {
            try {
                const response = await fetch('/api/current', {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    if (data.completed) {
                        alert('ğŸ‰ ëª¨ë“  ë²ˆì—­ ì™„ë£Œ!\n\në‹¤ë¥¸ íŒŒì¼ì„ ì„ íƒí•˜ë ¤ë©´ ìƒˆë¡œê³ ì¹¨(F5)í•˜ì„¸ìš”.');
                        return;
                    }
                    
                    currentData = data.data;
                    updateUI(currentData);
                } else {
                    alert('ì˜¤ë¥˜: ' + data.error);
                }
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI(data) {
            document.getElementById('startSection').classList.add('hidden');
            document.getElementById('translationSection').classList.remove('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('statsSection').classList.remove('hidden');
            
            // ì›ë¬¸
            document.getElementById('originalText').textContent = data.original;
            
            // ì»¨í…ìŠ¤íŠ¸
            if (data.context) {
                document.getElementById('contextText').textContent = 'ğŸ’¡ ' + data.context;
                document.getElementById('contextText').classList.remove('hidden');
            } else {
                document.getElementById('contextText').classList.add('hidden');
            }
            
            // ë²ˆì—­
            document.getElementById('translation1').querySelector('.text').textContent = data.translations[0];
            document.getElementById('translation2').querySelector('.text').textContent = data.translations[1];
            
            // í†µê³„
            const progress = Math.min(100, (data.current / data.total * 100)).toFixed(1);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').textContent = progress + '%';
            
            // currentê°€ totalì„ ë„˜ì§€ ì•Šë„ë¡ í‘œì‹œ
            const displayCurrent = Math.min(data.current, data.total);
            document.getElementById('statProgress').textContent = `${displayCurrent}/${data.total}`;
            document.getElementById('statTranslated').textContent = data.translation_count;
            
            // ì´ˆê¸°í™”
            selectedTranslation = null;
            document.getElementById('translation1').classList.remove('selected');
            document.getElementById('translation2').classList.remove('selected');
            document.getElementById('editSection').classList.add('hidden');
            document.getElementById('actionButtons').classList.remove('hidden');
            document.getElementById('saveButtons').classList.add('hidden');
            
            // í¸ì§‘ ë²„íŠ¼ ë³µì›
            document.getElementById('editButtonWrapper').classList.remove('hidden');
            document.getElementById('cancelKbd').textContent = '4';
        }
        
        // ë²ˆì—­ ì„ íƒ (í´ë¦­)
        function selectTranslation(num) {
            selectedTranslation = num;
            document.getElementById('translation1').classList.remove('selected');
            document.getElementById('translation2').classList.remove('selected');
            document.getElementById(`translation${num}`).classList.add('selected');
        }
        
        // ì•¡ì…˜ ì„ íƒ
        async function selectAction(action) {
            if (action === 1 || action === 2) {
                // ë²ˆì—­ ì„ íƒ â†’ ì €ì¥ ë‹¨ê³„ë¡œ (ì €ì¥ ë‹¨ê³„ì—ì„œë„ í¸ì§‘ ê°€ëŠ¥!)
                selectedTranslation = action;
                document.getElementById('translation1').classList.remove('selected');
                document.getElementById('translation2').classList.remove('selected');
                document.getElementById(`translation${action}`).classList.add('selected');
                
                // ì €ì¥ ë‹¨ê³„ë¡œ ì „í™˜
                document.getElementById('actionButtons').classList.add('hidden');
                document.getElementById('saveButtons').classList.remove('hidden');
                
            } else if (action === 3) {
                // ìš©ì–´ì§‘
                showGlossary();
                
            } else if (action === 4) {
                // ê±´ë„ˆë›°ê¸°
                showLoading('ê±´ë„ˆë›°ëŠ” ì¤‘...');
                
                try {
                    const response = await fetch('/api/select', {
                        method: 'POST',
                        headers: getApiHeaders({'Content-Type': 'application/json'}),
                        body: JSON.stringify({choice: 5})
                    });
                    
                    const data = await response.json();
                    hideLoading();
                    
                    if (data.success) {
                        loadCurrentItem();
                    }
                } catch (error) {
                    hideLoading();
                    alert('ì˜¤ë¥˜: ' + error.message);
                }
            }
        }
        
        // ì €ì¥ ì•¡ì…˜
        async function saveAction(action) {
            if (action === 3) {
                // í¸ì§‘
                if (!selectedTranslation) {
                    alert('ë¨¼ì € ë²ˆì—­ì„ ì„ íƒí•˜ì„¸ìš”');
                    return;
                }
                
                const selectedText = currentData.translations[selectedTranslation - 1];
                document.getElementById('editArea').value = selectedText;
                document.getElementById('editSection').classList.remove('hidden');
                
                // í¸ì§‘ ë²„íŠ¼ ìˆ¨ê¸°ê³  ì·¨ì†Œ ë²„íŠ¼ ë²ˆí˜¸ë¥¼ 3ìœ¼ë¡œ ë³€ê²½
                document.getElementById('editButtonWrapper').classList.add('hidden');
                document.getElementById('cancelKbd').textContent = '3';
                return;
            }
            
            if (action === 4) {
                // ì·¨ì†Œ
                document.getElementById('editSection').classList.add('hidden');
                document.getElementById('actionButtons').classList.remove('hidden');
                document.getElementById('saveButtons').classList.add('hidden');
                selectedTranslation = null;
                document.getElementById('translation1').classList.remove('selected');
                document.getElementById('translation2').classList.remove('selected');
                
                // í¸ì§‘ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê²Œ í•˜ê³  ì·¨ì†Œ ë²„íŠ¼ ë²ˆí˜¸ë¥¼ 4ë¡œ ë³µì›
                document.getElementById('editButtonWrapper').classList.remove('hidden');
                document.getElementById('cancelKbd').textContent = '4';
                return;
            }
            
            let translation;
            
            // í¸ì§‘ ëª¨ë“œì¸ ê²½ìš°
            if (!document.getElementById('editSection').classList.contains('hidden')) {
                translation = document.getElementById('editArea').value;
            } else {
                if (!selectedTranslation) {
                    alert('ë²ˆì—­ì„ ì„ íƒí•˜ì„¸ìš”');
                    return;
                }
                translation = currentData.translations[selectedTranslation - 1];
            }
            
            showLoading('ì €ì¥ ì¤‘...');
            
            try {
                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: getApiHeaders({'Content-Type': 'application/json'}),
                    body: JSON.stringify({
                        translation: translation,
                        save_type: action
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    if (data.completed) {
                        alert('ğŸ‰ ëª¨ë“  ë²ˆì—­ ì™„ë£Œ!\n\në‹¤ë¥¸ íŒŒì¼ì„ ì„ íƒí•˜ë ¤ë©´ ìƒˆë¡œê³ ì¹¨(F5)í•˜ì„¸ìš”.');
                    } else {
                        loadCurrentItem();
                    }
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ìš©ì–´ì§‘ í‘œì‹œ
        async function showGlossary() {
            try {
                const response = await fetch('/api/glossary', {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const list = document.getElementById('glossaryList');
                    list.innerHTML = '';
                    
                    for (const [en, ko] of Object.entries(data.glossary)) {
                        const item = document.createElement('div');
                        item.className = 'file-item';
                        item.innerHTML = `<strong>${en}</strong> â†’ ${ko}`;
                        list.appendChild(item);
                    }
                    
                    document.getElementById('glossaryModal').classList.add('show');
                }
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ìš©ì–´ì§‘ ì¶”ê°€
        function addGlossaryTerm() {
            const en = prompt('ì˜ì–´ ë‹¨ì–´:');
            if (!en) return;
            
            const ko = prompt('í•œêµ­ì–´ ë²ˆì—­:');
            if (!ko) return;
            
            fetch('/api/glossary', {
                method: 'POST',
                headers: getApiHeaders({'Content-Type': 'application/json'}),
                body: JSON.stringify({
                    action: 'add',
                    en: en,
                    ko: ko
                })
            }).then(() => {
                showGlossary();
            });
        }
        
        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('fileModal').classList.remove('show');
        }
        
        function closeGlossaryModal() {
            document.getElementById('glossaryModal').classList.remove('show');
        }
        
        // ë¡œë”© í‘œì‹œ
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSection').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingSection').classList.add('hidden');
        }
        
    </script>
</body>
</html>

