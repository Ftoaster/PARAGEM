<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåê Paratranz Î≤àÏó≠Í∏∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 20px;
        }
        
        /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 15px;
                border-radius: 12px;
            }
            
            .header h1 {
                font-size: 1.5em !important;
            }
            
            .button-wrapper {
                min-width: 80px !important;
            }
            
            .button-wrapper kbd {
                font-size: 0.7em !important;
                padding: 1px 4px !important;
            }
            
            button {
                padding: 10px 12px !important;
                font-size: 0.85em !important;
            }
            
            .original-text, .translation-option {
                font-size: 0.9em;
                padding: 10px;
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            background: #f0f0f0;
            border-radius: 8px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box .label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-box .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }
        
        .original-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
        }
        
        .context-text {
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #856404;
            margin-bottom: 15px;
        }
        
        .translation-option {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .translation-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .translation-option.selected {
            border-color: #667eea;
            background: #e8f0ff;
        }
        
        .translation-option .number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.9em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 120px;
        }
        
        .button-wrapper kbd {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        button {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-warning:hover:not(:disabled) {
            background: #e68900;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }
        
        .edit-area {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 10px;
        }
        
        .edit-area:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }
        
        .file-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-item:hover {
            background: #e8f0ff;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        /* ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 1em;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.error {
            background: #f44336;
        }
        
        .toast.warning {
            background: #ff9800;
        }
        
        .toast.info {
            background: #2196f3;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .spinner {
            border: 4px solid #f0f0f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
            margin-bottom: 15px;
        }
        
        #loadingText {
            font-size: 1em;
            font-weight: bold;
            color: #333;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ìó§Îçî -->
        <div class="header">
            <h1>üåê Paratranz Î≤àÏó≠Í∏∞</h1>
            <p>Gemini API Í∏∞Î∞ò Í≤åÏûÑ Î≤àÏó≠ ÎèÑÍµ¨</p>
        </div>
        
        
        <!-- ÏßÑÌñâÎ•† -->
        <div id="progressSection" class="hidden">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
            </div>
        </div>
        
        <!-- ÌÜµÍ≥Ñ -->
        <div id="statsSection" class="stats hidden">
            <div class="stat-box">
                <div class="label">üìä ÏßÑÌñâ</div>
                <div class="value" id="statProgress">0/0</div>
            </div>
            <div class="stat-box">
                <div class="label">‚úÖ ÏôÑÎ£å</div>
                <div class="value" id="statTranslated">0</div>
            </div>
        </div>
        
        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† -->
        <div id="startSection">
            <!-- API ÌÇ§ ÏÑ§Ï†ï -->
            <div id="apiKeySection" class="section">
                <div class="section-title">üîë API ÌÇ§ ÏÑ§Ï†ï</div>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                    Ï≤òÏùå Ìïú Î≤àÎßå ÏûÖÎ†•ÌïòÎ©¥ Î∏åÎùºÏö∞Ï†ÄÏóê Ï†ÄÏû•Îê©ÎãàÎã§.
                </p>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Paratranz API ÌÇ§:
                    </label>
                    <input type="password" id="paratranzApiKey" class="edit-area" 
                           style="min-height: auto; height: 40px;" 
                           placeholder="Ïó¨Í∏∞Ïóê Paratranz API ÌÇ§ ÏûÖÎ†•">
                    <small style="color: #666;">
                        <a href="https://paratranz.cn/users/my" target="_blank">Ïó¨Í∏∞ÏÑú Î∞úÍ∏â</a>
                    </small>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Gemini API ÌÇ§:
                    </label>
                    <input type="password" id="geminiApiKey" class="edit-area" 
                           style="min-height: auto; height: 40px;" 
                           placeholder="Ïó¨Í∏∞Ïóê Gemini API ÌÇ§ ÏûÖÎ†•">
                    <small style="color: #666;">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank">Ïó¨Í∏∞ÏÑú Î∞úÍ∏â</a>
                    </small>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        Gemini Î™®Îç∏:
                    </label>
                    <select id="geminiModel" class="edit-area" style="min-height: auto; height: 50px; cursor: pointer; padding: 10px; font-size: 0.95em;">
                        <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite (1500/day, Îπ†Î¶Ñ, Ï†ÄÎπÑÏö©)</option>
                        <option value="gemini-2.5-flash">gemini-2.5-flash (1500/day, Îπ†Î¶Ñ, ÌíàÏßà Ï§ëÍ∞Ñ)</option>
                        <option value="gemini-2.5-pro">gemini-2.5-pro (50/day, ÎäêÎ¶º, ÏµúÍ≥† ÌíàÏßà)</option>
                    </select>
                    <small style="color: #666;">
                        Î™®Îç∏Î≥Ñ ÏùºÏùº ÌïúÎèÑÏôÄ ÌíàÏßàÏù¥ Îã§Î¶ÖÎãàÎã§
                    </small>
                </div>
                <button class="btn-success" onclick="saveApiKeys()">üíæ Ï†ÄÏû•ÌïòÍ≥† ÏãúÏûë</button>
            </div>
            
            <!-- ÌååÏùº ÏÑ†ÌÉù (API ÌÇ§ ÏûÖÎ†• ÌõÑ ÌëúÏãú) -->
            <div id="fileSection" class="section hidden">
                <div class="section-title">üìÅ ÌååÏùº ÏÑ†ÌÉù</div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="loadFiles()">ÌååÏùº Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞</button>
                    <button class="btn-secondary" onclick="showApiKeySection()">üîë API ÌÇ§ Î≥ÄÍ≤Ω</button>
                </div>
            </div>
        </div>
        
        <div id="translationSection" class="hidden">
            <!-- ÏõêÎ¨∏ -->
            <div class="section">
                <div class="section-title">üìù ÏõêÎ¨∏</div>
                <div id="originalText" class="original-text"></div>
                <div id="contextText" class="context-text hidden"></div>
            </div>
            
            <!-- Î≤àÏó≠ -->
            <div class="section">
                <div class="section-title">ü§ñ AI Î≤àÏó≠ (2Í∞ÄÏßÄ)</div>
                <div id="translation1" class="translation-option" onclick="selectTranslation(1)">
                    <span class="number">1</span>
                    <span class="text"></span>
                </div>
                <div id="translation2" class="translation-option" onclick="selectTranslation(2)">
                    <span class="number">2</span>
                    <span class="text"></span>
                </div>
            </div>
            
            <!-- Ìé∏Ïßë ÏòÅÏó≠ (Ïà®ÍπÄ) -->
            <div id="editSection" class="section hidden">
                <div class="section-title">‚úèÔ∏è Î≤àÏó≠ Ìé∏Ïßë</div>
                <textarea id="editArea" class="edit-area" placeholder="Î≤àÏó≠ÏùÑ ÏàòÏ†ïÌïòÏÑ∏Ïöî..."></textarea>
            </div>
            
            <!-- Ïï°ÏÖò Î≤ÑÌäº -->
            <div id="actionButtons" class="button-group">
                <div class="button-wrapper">
                    <kbd>1</kbd>
                    <button class="btn-primary" onclick="selectAction(1)">üìù Ï≤´ Î≤àÏß∏</button>
                </div>
                <div class="button-wrapper">
                    <kbd>2</kbd>
                    <button class="btn-primary" onclick="selectAction(2)">üìù Îëê Î≤àÏß∏</button>
                </div>
                <div class="button-wrapper">
                    <kbd>3</kbd>
                    <button class="btn-secondary" onclick="selectAction(3)">üìö Ïö©Ïñ¥Ïßë</button>
                </div>
                <div class="button-wrapper">
                    <kbd>4</kbd>
                    <button class="btn-secondary" onclick="selectAction(4)">‚è≠Ô∏è Í±¥ÎÑàÎõ∞Í∏∞</button>
                </div>
            </div>
            
            <!-- Ï†ÄÏû• Î≤ÑÌäº (Ïà®ÍπÄ) -->
            <div id="saveButtons" class="button-group hidden">
                <div class="button-wrapper">
                    <kbd>1</kbd>
                    <button class="btn-success" onclick="saveAction(1)">üíæ Ï†ÄÏû•</button>
                </div>
                <div class="button-wrapper">
                    <kbd>2</kbd>
                    <button class="btn-warning" onclick="saveAction(2)">üìù Í≤ÄÌÜ†</button>
                </div>
                <div id="editButtonWrapper" class="button-wrapper">
                    <kbd>3</kbd>
                    <button class="btn-warning" onclick="saveAction(3)">‚úèÔ∏è Ìé∏Ïßë</button>
                </div>
                <div id="cancelButtonWrapper" class="button-wrapper">
                    <kbd id="cancelKbd">4</kbd>
                    <button class="btn-secondary" onclick="saveAction(4)">‚ùå Ï∑®ÏÜå</button>
                </div>
            </div>
        </div>
        
        <!-- Î°úÎî© -->
        <div id="loadingSection" class="loading hidden">
            <div class="spinner"></div>
            <div id="loadingText">Ï≤òÎ¶¨ Ï§ë...</div>
        </div>
        
    </div>
    
    <!-- ÌååÏùº ÏÑ†ÌÉù Î™®Îã¨ -->
    <div id="fileModal" class="modal">
        <div class="modal-content">
            <div class="section-title">üìÅ ÌååÏùº ÏÑ†ÌÉù</div>
            <select id="fileSelect" size="10" style="height: 300px;"></select>
            <div style="margin-top: 15px;">
                <div class="section-title">üìä Î≤àÏó≠ Îã®Í≥Ñ ÏÑ†ÌÉù</div>
                <select id="stageSelect">
                    <option value="0">ÎØ∏Î≤àÏó≠</option>
                    <option value="1">Î≤àÏó≠Îê®</option>
                    <option value="5">Í≤ÄÌÜ†Îê®</option>
                </select>
            </div>
            <div class="button-group" style="margin-top: 15px;">
                <button class="btn-primary" onclick="startTranslation()">ÏãúÏûë</button>
                <button class="btn-secondary" onclick="closeModal()">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>
    
    <!-- Ïö©Ïñ¥Ïßë Î™®Îã¨ -->
    <div id="glossaryModal" class="modal">
        <div class="modal-content">
            <div class="section-title">üìö Ïö©Ïñ¥Ïßë Í¥ÄÎ¶¨</div>
            <div id="glossaryList" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;"></div>
            <div class="button-group">
                <button class="btn-primary" onclick="addGlossaryTerm()">Ï∂îÍ∞Ä</button>
                <button class="btn-secondary" onclick="closeGlossaryModal()">Îã´Í∏∞</button>
            </div>
        </div>
    </div>

    <script>
        let selectedTranslation = null;
        let currentData = null;
        let selectedFileId = null;
        let selectedStage = null;
        let userApiKeys = {
            paratranz: '',
            gemini: '',
            model: 'gemini-2.5-flash-lite'
        };
        let sessionId = null;  // üîí ÏÑ∏ÏÖò ID (Ïû†Í∏àÏö©)
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï†ÄÏû•Îêú API ÌÇ§ ÌôïÏù∏ + ÏÑ∏ÏÖò ID ÏÉùÏÑ±
        window.addEventListener('DOMContentLoaded', async () => {
            // üîí ÏÑ∏ÏÖò ID ÏÉùÏÑ±
            try {
                const response = await fetch('/api/session');
                const data = await response.json();
                sessionId = data.session_id;
                console.log('üîí ÏÑ∏ÏÖò ID:', sessionId.substring(0, 8) + '...');
            } catch (e) {
                console.error('ÏÑ∏ÏÖò ID ÏÉùÏÑ± Ïã§Ìå®:', e);
                sessionId = 'fallback-' + Date.now();
            }
            
            loadSavedApiKeys();
        });
        
        // ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º ÌëúÏãú Ìï®Ïàò
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 3Ï¥à ÌõÑ Ï†úÍ±∞
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // Ï†ÄÏû•Îêú API ÌÇ§ Î∂àÎü¨Ïò§Í∏∞
        function loadSavedApiKeys() {
            const paratranzKey = localStorage.getItem('paratranz_api_key');
            const geminiKey = localStorage.getItem('gemini_api_key');
            const geminiModel = localStorage.getItem('gemini_model') || 'gemini-2.5-flash-lite';
            
            if (paratranzKey && geminiKey) {
                userApiKeys.paratranz = paratranzKey;
                userApiKeys.gemini = geminiKey;
                userApiKeys.model = geminiModel;
                
                // API ÌÇ§Í∞Ä ÏûàÏúºÎ©¥ ÌååÏùº ÏÑ†ÌÉù ÌôîÎ©¥ÏúºÎ°ú
                document.getElementById('apiKeySection').classList.add('hidden');
                document.getElementById('fileSection').classList.remove('hidden');
            } else {
                // API ÌÇ§Í∞Ä ÏóÜÏúºÎ©¥ ÏûÖÎ†• ÌôîÎ©¥ ÌëúÏãú
                document.getElementById('apiKeySection').classList.remove('hidden');
                document.getElementById('fileSection').classList.add('hidden');
            }
        }
        
        // API Ìó§Îçî ÏÉùÏÑ± (Î™®Îì† API Ìò∏Ï∂úÏóê ÏÇ¨Ïö©)
        function getApiHeaders(additionalHeaders = {}) {
            return {
                'X-Paratranz-Key': userApiKeys.paratranz,
                'X-Gemini-Key': userApiKeys.gemini,
                'X-Gemini-Model': userApiKeys.model,
                'X-Session-ID': sessionId,  // üîí Ïû†Í∏àÏö© ÏÑ∏ÏÖò ID
                ...additionalHeaders
            };
        }
        
        // API ÌÇ§ Ï†ÄÏû•
        function saveApiKeys() {
            const paratranzKey = document.getElementById('paratranzApiKey').value.trim();
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            const geminiModel = document.getElementById('geminiModel').value;
            
            if (!paratranzKey || !geminiKey) {
                showToast('Î™®Îì† API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!', 'error');
                return;
            }
            
            // localStorageÏóê Ï†ÄÏû•
            localStorage.setItem('paratranz_api_key', paratranzKey);
            localStorage.setItem('gemini_api_key', geminiKey);
            localStorage.setItem('gemini_model', geminiModel);
            
            userApiKeys.paratranz = paratranzKey;
            userApiKeys.gemini = geminiKey;
            userApiKeys.model = geminiModel;
            
            // ÌååÏùº ÏÑ†ÌÉù ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
            document.getElementById('apiKeySection').classList.add('hidden');
            document.getElementById('fileSection').classList.remove('hidden');
            
            showToast('‚úÖ API ÌÇ§Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
        }
        
        // API ÌÇ§ ÏÑ§Ï†ï ÌôîÎ©¥ Îã§Ïãú Î≥¥Í∏∞
        function showApiKeySection() {
            document.getElementById('fileSection').classList.add('hidden');
            document.getElementById('apiKeySection').classList.remove('hidden');
            
            // ÌòÑÏû¨ Ï†ÄÏû•Îêú ÌÇ§ ÌëúÏãú
            const paratranzKey = localStorage.getItem('paratranz_api_key');
            const geminiKey = localStorage.getItem('gemini_api_key');
            const geminiModel = localStorage.getItem('gemini_model') || 'gemini-2.5-flash-lite';
            
            if (paratranzKey) {
                document.getElementById('paratranzApiKey').value = paratranzKey;
            }
            if (geminiKey) {
                document.getElementById('geminiApiKey').value = geminiKey;
            }
            document.getElementById('geminiModel').value = geminiModel;
        }
        
        // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏
        document.addEventListener('keydown', (e) => {
            // ÏûÖÎ†• Ï§ëÏù¥Î©¥ Î¨¥Ïãú
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            
            const key = e.key;
            
            // Î≤àÏó≠ ÌôîÎ©¥
            if (!document.getElementById('translationSection').classList.contains('hidden')) {
                // Ï†ÄÏû• Î≤ÑÌäºÏù¥ Î≥¥Ïù¥Î©¥
                if (!document.getElementById('saveButtons').classList.contains('hidden')) {
                    // Ìé∏Ïßë Î™®ÎìúÏù∏ÏßÄ ÌôïÏù∏
                    const isEditMode = !document.getElementById('editSection').classList.contains('hidden');
                    
                    if (isEditMode) {
                        // Ìé∏Ïßë Î™®Îìú: 1(Ï†ÄÏû•), 2(Í≤ÄÌÜ†), 3(Ï∑®ÏÜå)
                        if (key === '1') saveAction(1);
                        else if (key === '2') saveAction(2);
                        else if (key === '3') saveAction(4); // 3Î≤à ÌÇ§ = Ï∑®ÏÜå
                    } else {
                        // ÏùºÎ∞ò Î™®Îìú: 1(Ï†ÄÏû•), 2(Í≤ÄÌÜ†), 3(Ìé∏Ïßë), 4(Ï∑®ÏÜå)
                        if (key >= '1' && key <= '4') {
                            saveAction(parseInt(key));
                        }
                    }
                }
                // Ïï°ÏÖò Î≤ÑÌäºÏù¥ Î≥¥Ïù¥Î©¥
                else if (!document.getElementById('actionButtons').classList.contains('hidden')) {
                    if (key >= '1' && key <= '4') {
                        selectAction(parseInt(key));
                    }
                }
            }
        });
        
        // ÌååÏùº Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
        async function loadFiles() {
            showLoading('ÌååÏùº Î™©Î°ù Î∂àÎü¨Ïò§Îäî Ï§ë...');
            
            try {
                const response = await fetch('/api/files', {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                hideLoading();
                
                if (data.success) {
                    const select = document.getElementById('fileSelect');
                    select.innerHTML = '';
                    
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.id;
                        option.textContent = `${file.name} (${file.translated}/${file.total})`;
                        select.appendChild(option);
                    });
                    
                    document.getElementById('fileModal').classList.add('show');
                } else {
                    alert('ÌååÏùº Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                alert('Ïò§Î•ò: ' + error.message);
            }
        }
        
        // Î≤àÏó≠ ÏãúÏûë
        async function startTranslation() {
            const select = document.getElementById('fileSelect');
            const stageSelect = document.getElementById('stageSelect');
            
            if (!select.value) {
                alert('ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
                return;
            }
            
            selectedFileId = parseInt(select.value);
            selectedStage = parseInt(stageSelect.value);
            
            closeModal();
            showLoading('Î≤àÏó≠ Ï§ÄÎπÑ Ï§ë...');
            
            try {
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: getApiHeaders({'Content-Type': 'application/json'}),
                    body: JSON.stringify({
                        file_id: selectedFileId,
                        stage: selectedStage
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    if (data.completed) {
                        alert('üéâ Î™®Îì† Î≤àÏó≠ ÏôÑÎ£å!\n\nÎã§Î•∏ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÎ†§Î©¥ ÏÉàÎ°úÍ≥†Ïπ®(F5)ÌïòÏÑ∏Ïöî.');
                    } else {
                        loadCurrentItem();
                    }
                } else {
                    alert('Ïò§Î•ò: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                alert('Ïò§Î•ò: ' + error.message);
            }
        }
        
        // ÌòÑÏû¨ Ìï≠Î™© Î∂àÎü¨Ïò§Í∏∞
        async function loadCurrentItem() {
            try {
                const response = await fetch('/api/current', {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    if (data.completed) {
                        alert('üéâ Î™®Îì† Î≤àÏó≠ ÏôÑÎ£å!\n\nÎã§Î•∏ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÎ†§Î©¥ ÏÉàÎ°úÍ≥†Ïπ®(F5)ÌïòÏÑ∏Ïöî.');
                        return;
                    }
                    
                    currentData = data.data;
                    updateUI(currentData);
                } else {
                    alert('Ïò§Î•ò: ' + data.error);
                }
            } catch (error) {
                alert('Ïò§Î•ò: ' + error.message);
            }
        }
        
        // UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateUI(data) {
            document.getElementById('startSection').classList.add('hidden');
            document.getElementById('translationSection').classList.remove('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('statsSection').classList.remove('hidden');
            
            // ÏõêÎ¨∏
            document.getElementById('originalText').textContent = data.original;
            
            // Ïª®ÌÖçÏä§Ìä∏
            if (data.context) {
                document.getElementById('contextText').textContent = 'üí° ' + data.context;
                document.getElementById('contextText').classList.remove('hidden');
            } else {
                document.getElementById('contextText').classList.add('hidden');
            }
            
            // Î≤àÏó≠
            document.getElementById('translation1').querySelector('.text').textContent = data.translations[0];
            document.getElementById('translation2').querySelector('.text').textContent = data.translations[1];
            
            // ÌÜµÍ≥Ñ
            const progress = Math.min(100, (data.current / data.total * 100)).toFixed(1);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').textContent = progress + '%';
            
            // currentÍ∞Ä totalÏùÑ ÎÑòÏßÄ ÏïäÎèÑÎ°ù ÌëúÏãú
            const displayCurrent = Math.min(data.current, data.total);
            document.getElementById('statProgress').textContent = `${displayCurrent}/${data.total}`;
            document.getElementById('statTranslated').textContent = data.translation_count;
            
            // Ï¥àÍ∏∞Ìôî
            selectedTranslation = null;
            document.getElementById('translation1').classList.remove('selected');
            document.getElementById('translation2').classList.remove('selected');
            document.getElementById('editSection').classList.add('hidden');
            document.getElementById('actionButtons').classList.remove('hidden');
            document.getElementById('saveButtons').classList.add('hidden');
            
            // Ìé∏Ïßë Î≤ÑÌäº Î≥µÏõê
            document.getElementById('editButtonWrapper').classList.remove('hidden');
            document.getElementById('cancelKbd').textContent = '4';
        }
        
        // Î≤àÏó≠ ÏÑ†ÌÉù (ÌÅ¥Î¶≠)
        function selectTranslation(num) {
            selectedTranslation = num;
            document.getElementById('translation1').classList.remove('selected');
            document.getElementById('translation2').classList.remove('selected');
            document.getElementById(`translation${num}`).classList.add('selected');
        }
        
        // Ïï°ÏÖò ÏÑ†ÌÉù
        async function selectAction(action) {
            if (action === 1 || action === 2) {
                // Î≤àÏó≠ ÏÑ†ÌÉù ‚Üí Ï†ÄÏû• Îã®Í≥ÑÎ°ú (Ï†ÄÏû• Îã®Í≥ÑÏóêÏÑúÎèÑ Ìé∏Ïßë Í∞ÄÎä•!)
                selectedTranslation = action;
                document.getElementById('translation1').classList.remove('selected');
                document.getElementById('translation2').classList.remove('selected');
                document.getElementById(`translation${action}`).classList.add('selected');
                
                // Ï†ÄÏû• Îã®Í≥ÑÎ°ú Ï†ÑÌôò
                document.getElementById('actionButtons').classList.add('hidden');
                document.getElementById('saveButtons').classList.remove('hidden');
                
            } else if (action === 3) {
                // Ïö©Ïñ¥Ïßë
                showGlossary();
                
            } else if (action === 4) {
                // Í±¥ÎÑàÎõ∞Í∏∞
                showLoading('Í±¥ÎÑàÎõ∞Îäî Ï§ë...');
                
                try {
                    const response = await fetch('/api/select', {
                        method: 'POST',
                        headers: getApiHeaders({'Content-Type': 'application/json'}),
                        body: JSON.stringify({choice: 5})
                    });
                    
                    const data = await response.json();
                    hideLoading();
                    
                    if (data.success) {
                        loadCurrentItem();
                    }
                } catch (error) {
                    hideLoading();
                    alert('Ïò§Î•ò: ' + error.message);
                }
            }
        }
        
        // Ï†ÄÏû• Ïï°ÏÖò
        async function saveAction(action) {
            if (action === 3) {
                // Ìé∏Ïßë
                if (!selectedTranslation) {
                    alert('Î®ºÏ†Ä Î≤àÏó≠ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
                    return;
                }
                
                const selectedText = currentData.translations[selectedTranslation - 1];
                document.getElementById('editArea').value = selectedText;
                document.getElementById('editSection').classList.remove('hidden');
                
                // Ìé∏Ïßë Î≤ÑÌäº Ïà®Í∏∞Í≥† Ï∑®ÏÜå Î≤ÑÌäº Î≤àÌò∏Î•º 3ÏúºÎ°ú Î≥ÄÍ≤Ω
                document.getElementById('editButtonWrapper').classList.add('hidden');
                document.getElementById('cancelKbd').textContent = '3';
                return;
            }
            
            if (action === 4) {
                // Ï∑®ÏÜå
                document.getElementById('editSection').classList.add('hidden');
                document.getElementById('actionButtons').classList.remove('hidden');
                document.getElementById('saveButtons').classList.add('hidden');
                selectedTranslation = null;
                document.getElementById('translation1').classList.remove('selected');
                document.getElementById('translation2').classList.remove('selected');
                
                // Ìé∏Ïßë Î≤ÑÌäº Îã§Ïãú Î≥¥Ïù¥Í≤å ÌïòÍ≥† Ï∑®ÏÜå Î≤ÑÌäº Î≤àÌò∏Î•º 4Î°ú Î≥µÏõê
                document.getElementById('editButtonWrapper').classList.remove('hidden');
                document.getElementById('cancelKbd').textContent = '4';
                return;
            }
            
            let translation;
            
            // Ìé∏Ïßë Î™®ÎìúÏù∏ Í≤ΩÏö∞
            if (!document.getElementById('editSection').classList.contains('hidden')) {
                translation = document.getElementById('editArea').value;
            } else {
                if (!selectedTranslation) {
                    alert('Î≤àÏó≠ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');
                    return;
                }
                translation = currentData.translations[selectedTranslation - 1];
            }
            
            showLoading('Ï†ÄÏû• Ï§ë...');
            
            try {
                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: getApiHeaders({'Content-Type': 'application/json'}),
                    body: JSON.stringify({
                        translation: translation,
                        save_type: action
                    })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    if (data.completed) {
                        alert('üéâ Î™®Îì† Î≤àÏó≠ ÏôÑÎ£å!\n\nÎã§Î•∏ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÎ†§Î©¥ ÏÉàÎ°úÍ≥†Ïπ®(F5)ÌïòÏÑ∏Ïöî.');
                    } else {
                        loadCurrentItem();
                    }
                } else {
                    alert('Ï†ÄÏû• Ïã§Ìå®: ' + data.error);
                }
            } catch (error) {
                hideLoading();
                alert('Ïò§Î•ò: ' + error.message);
            }
        }
        
        // Ïö©Ïñ¥Ïßë ÌëúÏãú
        async function showGlossary() {
            try {
                const response = await fetch('/api/glossary', {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    const list = document.getElementById('glossaryList');
                    list.innerHTML = '';
                    
                    for (const [en, ko] of Object.entries(data.glossary)) {
                        const item = document.createElement('div');
                        item.className = 'file-item';
                        item.innerHTML = `<strong>${en}</strong> ‚Üí ${ko}`;
                        list.appendChild(item);
                    }
                    
                    document.getElementById('glossaryModal').classList.add('show');
                }
            } catch (error) {
                alert('Ïò§Î•ò: ' + error.message);
            }
        }
        
        // Ïö©Ïñ¥Ïßë Ï∂îÍ∞Ä
        function addGlossaryTerm() {
            const en = prompt('ÏòÅÏñ¥ Îã®Ïñ¥:');
            if (!en) return;
            
            const ko = prompt('ÌïúÍµ≠Ïñ¥ Î≤àÏó≠:');
            if (!ko) return;
            
            fetch('/api/glossary', {
                method: 'POST',
                headers: getApiHeaders({'Content-Type': 'application/json'}),
                body: JSON.stringify({
                    action: 'add',
                    en: en,
                    ko: ko
                })
            }).then(() => {
                showGlossary();
            });
        }
        
        // Î™®Îã¨ Îã´Í∏∞
        function closeModal() {
            document.getElementById('fileModal').classList.remove('show');
        }
        
        function closeGlossaryModal() {
            document.getElementById('glossaryModal').classList.remove('show');
        }
        
        // Î°úÎî© ÌëúÏãú
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSection').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingSection').classList.add('hidden');
        }
        
    </script>
</body>
</html>

